[{"id":"ed0c995d.e2e7f8","type":"tab","label":"entré MQTT","disabled":false,"info":""},{"id":"62e9dd9c.3ec8b4","type":"tab","label":"Login","disabled":false,"info":""},{"id":"c6f5a9d0.2bf118","type":"tab","label":"Simulation basic","disabled":false,"info":""},{"id":"79c89fe4.873e6","type":"tab","label":"get info","disabled":false,"info":""},{"id":"b9daa40a.159ce8","type":"tab","label":"Recommandations","disabled":false,"info":""},{"id":"da4609d5.3036c8","type":"tab","label":"testing","disabled":false,"info":""},{"id":"1dab1279.d003ee","type":"tab","label":"Sortie MQTT","disabled":false,"info":""},{"id":"4e4dbcc2.17d054","type":"subflow","name":"vérify token","info":"","in":[{"x":140,"y":320,"wires":[{"id":"e29f42ca.a113c"}]}],"out":[{"x":1220,"y":260,"wires":[{"id":"db0ceff6.603c","port":0}]}]},{"id":"3ba2a49e.7ce77c","type":"mongodb","z":"","hostname":"127.0.0.1","port":"27017","db":"MovIt","name":""},{"id":"311fce6b.a3ffd2","type":"mongodb2","name":""},{"id":"c2e023a5.ad0b","type":"mongodb2","z":"","uri":"mongodb://127.0.0.1:27017/MovIt","name":"MovIt","options":"","parallelism":"-1"},{"id":"94e4b2c8.735b8","type":"mongodb2","z":"","uri":"","name":"","options":"","parallelism":"-1"},{"id":"2b8661c7.194ede","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"9c42017f.b5ed3","type":"mqtt in","z":"ed0c995d.e2e7f8","name":"back angle","topic":"data/current_back_rest_angle","qos":"0","broker":"2b8661c7.194ede","x":220,"y":120,"wires":[["d353cbdb.5d4f58"]]},{"id":"1904009e.5a81df","type":"mqtt in","z":"ed0c995d.e2e7f8","name":"pressure","topic":"data/current_center_of_pressure","qos":"0","broker":"2b8661c7.194ede","x":220,"y":220,"wires":[["1c01fe0f.4afed2"]]},{"id":"c8f58011.f27ef","type":"mqtt in","z":"ed0c995d.e2e7f8","name":"someone","topic":"data/current_is_someone_there","qos":"0","broker":"2b8661c7.194ede","x":200,"y":320,"wires":[["d710158.344d1e8"]]},{"id":"e9a4e134.0416a","type":"http in","z":"62e9dd9c.3ec8b4","name":"","url":"/login","method":"post","upload":false,"swaggerDoc":"","x":90,"y":140,"wires":[["d7376764.918e88"]]},{"id":"c0aafdb5.90b58","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find user","collection":"User","operation":"findOne","x":580,"y":140,"wires":[["33c4d6e7.62eb2a"]]},{"id":"d7376764.918e88","type":"function","z":"62e9dd9c.3ec8b4","name":"get Username","func":"msg.payload= '{\"username\":\"'+msg.req.body.username+'\"}';\nvar crypto = context.global.cryptojs;\nmsg.pw = crypto.SHA256( msg.req.body.password).toString();\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":140,"wires":[["8386b3b8.afc4d"]]},{"id":"8386b3b8.afc4d","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"payload","action":"obj","pretty":false,"x":450,"y":140,"wires":[["c0aafdb5.90b58"]]},{"id":"33c4d6e7.62eb2a","type":"function","z":"62e9dd9c.3ec8b4","name":"validate Password","func":"if(msg.payload.password == msg.pw){\n    var token = context.global.cryptojs.lib.WordArray.random(32).toString();\n    msg.result ='{\"result\":0,\"token\":\"'+token+'\"}';\n    msg.payload.token= token;\n    msg.query ={\"username\":msg.payload.username}\n    msg.value= {\"username\":msg.payload.username,\"password\":msg.payload.password,\"token\":msg.payload.token};\n    msg.payload = [];\n    msg.payload[0]= msg.query;\n    msg.payload[1]=msg.value;\n}\nelse\n    msg.result = '{\"result\":401}';\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":140,"wires":[["89587608.3c4368"]]},{"id":"f787b8dd.85b708","type":"switch","z":"62e9dd9c.3ec8b4","name":"","property":"result.result","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"neq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":140,"wires":[["a7bcd925.e25508"],["4b672da8.cf9b54"]]},{"id":"a7bcd925.e25508","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"create token","collection":"User","operation":"findOneAndUpdate","x":1210,"y":80,"wires":[["4b672da8.cf9b54"]]},{"id":"a306472a.48f6f8","type":"http response","z":"62e9dd9c.3ec8b4","name":"","statusCode":"","headers":{},"x":1350,"y":220,"wires":[]},{"id":"4b672da8.cf9b54","type":"function","z":"62e9dd9c.3ec8b4","name":"send result","func":"msg.payload = msg.result;\nreturn msg;","outputs":1,"noerr":0,"x":1250,"y":140,"wires":[["a306472a.48f6f8"]]},{"id":"89587608.3c4368","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"result","action":"obj","pretty":false,"x":930,"y":140,"wires":[["f787b8dd.85b708"]]},{"id":"176575a7.f0811a","type":"function","z":"c6f5a9d0.2bf118","name":"creation test","func":"var times = 0;\nvar timeStamps = 1517439600000;\nvar angles =0 ;\nvar docs=[];\nvar k =0;\nfor(j=0;j<62;j++){\n    for(i=0;i<300;i++){\n        var date = new Date(timeStamps);\n\n        var document = {date:date ,timestamp:timeStamps, angle:angles, fake:\"1\"};\n\n        docs[k] =document;\n        \n        timeStamps +=288000;\n        angles = Math.round(Math.random()*45);\n        k++;\n    }\n    timeStamps +=288000;\n    angles = Math.round(Math.random()*45);\n}\nmsg.payload=[docs];\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":300,"wires":[["f4049ff5.d40db","3be155d4.aa209a"]]},{"id":"f4049ff5.d40db","type":"debug","z":"c6f5a9d0.2bf118","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":740,"y":320,"wires":[]},{"id":"3be155d4.aa209a","type":"mongodb2 in","z":"c6f5a9d0.2bf118","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"back_angle","operation":"insertMany","x":740,"y":260,"wires":[["bbb4df43.97676"]]},{"id":"b11fb1c5.774ca","type":"http in","z":"79c89fe4.873e6","name":"getDaysWithData","url":"/daysWithData","method":"get","upload":false,"swaggerDoc":"","x":140,"y":200,"wires":[["93bd1535.1e8c98"]]},{"id":"f16ebdef.b321d","type":"function","z":"79c89fe4.873e6","name":"getMinMax","func":"let min=0;\nlet max=9999999999999;\nlet offset =0;\nif(msg.payload.Offset !=null)\n    offset = parseInt(msg.payload.Offset)*60*60*1000;\n\nif(msg.payload.Min !=null){\n    min = parseInt(msg.payload.Min);\n}\nif(msg.payload.Max !=null){\n    max =  parseInt(msg.payload.Max);\n}\n msg.payload =[[{ \"$match\": { date: {$gte: new Date(min-offset), $lt: new Date(max-offset)} } },\n  { \"$project\": { \n      \"date\":\"$date\"\n    }},\n { \"$group\": { \n         \"_id\": null, \n        \"distinctDate\":{\"$addToSet\": { \"year\":{\"$year\":[{$add:[\"$date\",offset]}]}, \"month\":{\"$month\":[{$add:[\"$date\",offset]}]},\"day\": {\"$dayOfMonth\":[{$add:[\"$date\",offset]}]} }}\n    }}\n   ]];\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":200,"wires":[["9ff40d91.0ad8a"]]},{"id":"9ff40d91.0ad8a","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"back_angle","operation":"aggregate.toArray","x":910,"y":200,"wires":[["5d9b2fcb.692d8"]]},{"id":"5d9b2fcb.692d8","type":"function","z":"79c89fe4.873e6","name":"FormatData","func":"// msg.payload=msg.payload.map((element) => {\n//     const splitDate = element.split(\"/\");\n//     return {day:splitDate[2],month:splitDate[1],year:splitDate[0]};\n// })\nvar finalOutput={};\nvar distinctDates= msg.payload[0].distinctDate;\nfor(let date of distinctDates) {\n  if (finalOutput[date.year]) {\n    if (finalOutput[date.year][date.month]) {\n      finalOutput[date.year][date.month].push(date.day);\n    } else {\n      finalOutput[date.year][date.month] = [date.day];\n    }\n  } else {\n    finalOutput[date.year] = {\n      [date.month]: [date.day]\n    };\n  }\n}\nmsg.payload=finalOutput;\n\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":200,"wires":[["3da51abc.07fb96"]]},{"id":"768a845d.26bf5c","type":"mqtt in","z":"ed0c995d.e2e7f8","name":"speed","topic":"data/current_chair_speed","qos":"0","broker":"2b8661c7.194ede","x":190,"y":380,"wires":[["195ec0a8.18333f"]]},{"id":"cefddfdf.eda88","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"var flowContext = this.context.flow;\nif(flowContext.isSitting==null){\n    flowContext.isSitting=0;\n}\nvar angles =msg.payload.angle;\nif( flowContext.isSitting==1){\n       var date = new Date(msg.payload.datetime);\n       date.setUTCMinutes(date.getMinutes()-date.getTimezoneOffset());\n        msg.payload = {date:date ,timestamp:date.getTime(), angle:angles,sitting:1, fake:\"0\"};\n}\nelse{\n    msg.payload=null;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":80,"wires":[["14d35acb.066145"]]},{"id":"6c4c2373.39613c","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"var flowContext = this.context.flow;\nif(flowContext.isSitting==null){\n    flowContext.isSitting=0;\n}\nvar angles =msg.payload.angle;\nif( flowContext.isSitting==1){\n       var date = new Date(msg.payload.datetime);\n       date.setUTCMinutes(date.getMinutes()-date.getTimezoneOffset());\n        msg.payload = {date:date ,timestamp:date.getTime(), posX:msg.payload.pos_x, posY:msg.payload.pos_y, fake:\"0\"};\n}\nelse{\n    msg.payload=null;\n}\n\nreturn msg;return msg;","outputs":1,"noerr":0,"x":530,"y":180,"wires":[["23b75a55.df6646"]]},{"id":"51301068.f29e4","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"var flowContext = this.context.flow;\nflowContext.isSitting=msg.payload.IsSomeoneThere;\n\n var date = new Date(msg.payload.datetime);\n       date.setUTCMinutes(date.getMinutes()-date.getTimezoneOffset());\n       msg.payload = {date:date ,timestamp:date.getTime(), isSitting:msg.payload.IsSomeoneThere};\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":300,"wires":[["eda9ac1f.df1a1"]]},{"id":"f48b2a1f.dced18","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"console.log(\"Speed : \"+msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":380,"wires":[[]]},{"id":"334fcbeb.acd7d4","type":"http in","z":"79c89fe4.873e6","name":"getMonthWithData","url":"/monthsWithData","method":"get","upload":false,"swaggerDoc":"","x":190,"y":280,"wires":[["10b52e7e.2bc7c2"]]},{"id":"fec815ee.b66618","type":"function","z":"79c89fe4.873e6","name":"getMinMax","func":"let min=0;\nlet max=9999999999999;\nlet offset =0;\nif(msg.payload.Offset !=null)\n    offset = parseInt(msg.payload.Offset)*60*60*1000;\n\nif(msg.payload.Min !=null){\n    min = parseInt(msg.payload.Min);\n}\nif(msg.payload.Max !=null){\n    max =  parseInt(msg.payload.Max);\n}\n msg.payload =[[{ \"$match\": { date: {$gte:new Date(min-offset), $lt:new Date(max-offset)} } },\n  { \"$project\": { \n         \"date\": \"$date\" \n    }},\n { \"$group\": { \n         \"_id\": null, \n        \"distinctDate\":{\"$addToSet\": { \"year\":{\"$year\":[{$add:[\"$date\",offset]}]}, \"month\":{\"$month\":[{$add:[\"$date\",offset]}]} }}\n    }}\n   ]];\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":280,"wires":[["61ad48e3.eab1a8"]]},{"id":"61ad48e3.eab1a8","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"back_angle","operation":"aggregate.toArray","x":910,"y":280,"wires":[["21228476.a04b1c"]]},{"id":"21228476.a04b1c","type":"function","z":"79c89fe4.873e6","name":"FormatData","func":"// msg.payload=msg.payload.map((element) => {\n//     const splitDate = element.split(\"/\");\n//     return {day:splitDate[2],month:splitDate[1],year:splitDate[0]};\n// })\nvar finalOutput={};\nvar distinctDates= msg.payload[0].distinctDate;\nfor (let date of distinctDates) {\n  if (finalOutput[date.year]) {\n    finalOutput[date.year].push(date.month)\n  } else {\n    finalOutput[date.year] = [date.month];\n  }\n}\nmsg.payload=finalOutput;\n\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":280,"wires":[["3da51abc.07fb96"]]},{"id":"32438d51.b44d62","type":"http in","z":"79c89fe4.873e6","name":"getOneDay","url":"oneDay","method":"get","upload":false,"swaggerDoc":"","x":200,"y":400,"wires":[["6b826591.36243c"]]},{"id":"6d0b7a7a.0d05d4","type":"function","z":"79c89fe4.873e6","name":"get day","func":"\nlet offset =0;\nif(msg.payload.Offset !=null)\n    offset = parseInt(msg.payload.Offset)*60*60*1000;\n\nlet day=new Date(parseInt(msg.payload.Day));\nlet min=(day.setUTCHours(0,0,0,0))-offset;\nlet max = (day.setUTCHours(23,59,59,999))-offset;\n msg.payload =[[{ \"$match\": { date: {$gte:new Date(min), $lt:new Date(max)} } },\n  { \"$project\": { \n         \"date\": {$add:[\"$date\",offset]},\n         \"angle\":\"$angle\",\n         \"sitting\":\"$sitting\"\n    }},\n    { $sort: { date: 1}}\n   ]];\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":400,"wires":[["4c7cb0ed.941c3"]]},{"id":"4c7cb0ed.941c3","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find day","collection":"back_angle","operation":"aggregate.toArray","x":860,"y":400,"wires":[["3519207b.16f55"]]},{"id":"3519207b.16f55","type":"function","z":"79c89fe4.873e6","name":"format result","func":"let minus=0;\nlet zero=0;\nlet fifteen=0;\nlet thirty=0;\nlet more=0;\n\nlet distinctTime= msg.payload;\nif(distinctTime!=null){\n    let previous = distinctTime[0];\n    distinctTime.shift();\n    if(distinctTime.length == 0 ){\n        var lastTime=new Date(previous.date);\n            lastTime.setUTCHours(0,0,0,0);\n         if (previous.angle<0)\n            minus+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (15>previous.angle & previous.angle>=0)\n            zero+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (30>previous.angle & previous.angle>=15)\n            fifteen+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (45>=previous.angle & previous.angle>=30)\n            thirty+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (45<previous.angle)\n            more+= previous.date.getTime() - lastTime.getTime()+1;\n    }\n    else{\n        if(previous.sitting==0){\n             var lastTime=new Date(previous.date);\n            lastTime.setUTCHours(0,0,0,0);\n         if (previous.angle<0)\n            minus+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (15>previous.angle & previous.angle>=0)\n            zero+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (30>previous.angle & previous.angle>=15)\n            fifteen+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (45>=previous.angle & previous.angle>=30)\n            thirty+= previous.date.getTime() - lastTime.getTime()+1;\n        else if (45<previous.angle)\n            more+= previous.date.getTime() - lastTime.getTime()+1;\n        }\n        for(let time of distinctTime){\n            if(previous.sitting!=0){\n                if (previous.angle<0)\n                    minus+= time.date.getTime() - previous.date.getTime();\n                else if (15>previous.angle & previous.angle>=0)\n                    zero+= time.date.getTime() - previous.date.getTime();\n                else if (30>previous.angle & previous.angle>=15)\n                    fifteen+= time.date.getTime() - previous.date.getTime();\n                else if (45>=previous.angle & previous.angle>=30)\n                    thirty+= time.date.getTime() - previous.date.getTime();\n                else if (45<previous.angle)\n                    more+= time.date.getTime() - previous.date.getTime();\n            }\n            previous = time;\n        }\n        // if(previous.sitting !=0){\n        //      var lastTime=new Date(previous.date);\n        //         lastTime.setUTCHours(23,59,59,999);\n        //         if (previous.angle<0)\n        //         minus+= lastTime.getTime() - previous.date.getTime();\n        //     else if (15>previous.angle & previous.angle>=0)\n        //         zero+= lastTime.getTime() - previous.date.getTime();\n        //     else if (30>previous.angle & previous.angle>=15)\n        //         fifteen+= lastTime.getTime() - previous.date.getTime();\n        //     else if (45>=previous.angle & previous.angle>=30)\n        //         thirty+= lastTime.getTime() - previous.date.getTime();\n        //     else if (45<previous.angle)\n        //         more+= lastTime.getTime() - previous.date.getTime();\n        // }\n    }\n}\nmsg.payload = [minus,zero,fifteen,thirty,more];\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":400,"wires":[["3da51abc.07fb96"]]},{"id":"3da51abc.07fb96","type":"http response","z":"79c89fe4.873e6","name":"","statusCode":"","headers":{},"x":1350,"y":400,"wires":[]},{"id":"ca539df1.75ecd","type":"http in","z":"79c89fe4.873e6","name":"getOneMonth","url":"oneMonth","method":"get","upload":false,"swaggerDoc":"","x":190,"y":520,"wires":[["33bd490c.876dc6"]]},{"id":"cbdade80.832ba","type":"function","z":"79c89fe4.873e6","name":"get month","func":"\nlet offset =0;\nif(msg.payload.Offset !=null)\n    offset = parseInt(msg.payload.Offset)*60*60*1000;\nmsg.offset=offset;\nvar moment = context.global.momentjs;\nlet min=new Date(parseInt(msg.payload.Day));\nmin.setDate(1);\nmin.setUTCHours(0,0,0,0);\nvar momentMin =moment(min);\nmomentMin.add(-offset,\"ms\");\nvar max=moment(momentMin);\nmax.add(1, 'months');\n msg.payload =[[{ \"$match\": { date: {$gte:new Date(momentMin), $lt:new Date(max)} } },\n  { \"$project\": { \n         \"date\": {$add:[\"$date\",offset]},\n         \"angle\":\"$angle\",\n         \"sitting\":\"$sitting\"\n    }},\n    { $sort: { date: 1}}\n   ]];\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":520,"wires":[["72d0155a.a5d1cc"]]},{"id":"72d0155a.a5d1cc","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find month","collection":"back_angle","operation":"aggregate.toArray","x":860,"y":520,"wires":[["f6686f99.ccf1a"]]},{"id":"f6686f99.ccf1a","type":"function","z":"79c89fe4.873e6","name":"format result","func":"\nvar hash = {};\nvar offset = msg.offset;\nlet distinctTime= msg.payload;\nlet previous = distinctTime[0];\nvar previousDate;\ndistinctTime.shift();\nfor(let time of distinctTime){\n    previousDate =new Date(previous.date);\n    if(hash[previous.date.getUTCDate()]==null){\n        hash[previous.date.getUTCDate()]=[0,0,0,0,0]\n    }\n    if(hash[time.date.getUTCDate()]==null)\n        hash[time.date.getUTCDate()]=[0,0,0,0,0]\n    var currentDate =new Date(time.date);\n    if(currentDate.getUTCDate()==previousDate.getUTCDate()&previous.sitting==1){\n        if (previous.angle<0)\n            hash[previous.date.getUTCDate()][0]+= currentDate.getTime() - previousDate.getTime();\n        else if (15>previous.angle & previous.angle>=0)\n            hash[previous.date.getUTCDate()][1]+= currentDate.getTime() - previousDate.getTime();\n        else if (30>previous.angle & previous.angle>=15)\n            hash[previous.date.getUTCDate()][2]+= currentDate.getTime() - previousDate.getTime();\n        else if (45>=previous.angle & previous.angle>=30)\n            hash[previous.date.getUTCDate()][3]+= currentDate.getTime() - previousDate.getTime();\n        else if (45<previous.angle)\n            hash[previous.date.getUTCDate()][4]+= currentDate.getTime() - previousDate.getTime();\n    }\n    else if(previous.sitting==1){\n        var lastTime=new Date(previous.date);\n        lastTime.setUTCHours(23,59,59,999);\n        if (previous.angle<0)\n             hash[previousDate.getUTCDate()][0]= lastTime.getTime() - previousDate.getTime();\n        else if (15>previous.angle & previous.angle>=0)\n            hash[previousDate.getUTCDate()][1]+= lastTime.getTime() - previousDate.getTime();\n        else if (30>previous.angle & previous.angle>=15)\n            hash[previousDate.getUTCDate()][2]+= lastTime.getTime() - previousDate.getTime();\n        else if (45>=previous.angle & previous.angle>=30)\n            hash[previousDate.getUTCDate()][3]+= lastTime.getTime() - previousDate.getTime();\n        else if (45<previous.angle)\n            hash[previousDate.getUTCDate()][4]+= lastTime.getTime() - previousDate.getTime();\n        lastTime=new Date(currentDate);\n        lastTime.setUTCHours(0,0,0,0);\n        if (previous.angle<0)\n            hash[time.date.getUTCDate()][0]+= currentDate.getTime()-lastTime.getTime();\n        else if (15>previous.angle & previous.angle>=0)\n            hash[time.date.getUTCDate()][1]+= currentDate.getTime()-lastTime.getTime();\n        else if (30>previous.angle & previous.angle>=15)\n            hash[time.date.getUTCDate()][2]+= currentDate.getTime()-lastTime.getTime();\n        else if (45>=previous.angle & previous.angle>=30)\n            hash[time.date.getUTCDate()][3]+=  currentDate.getTime()-lastTime.getTime();\n        else if (45<previous.angle)\n            hash[time.date.getUTCDate()][4]+= currentDate.getTime()-lastTime.getTime();\n\n      \n    }\n    previous = time;\n}\nvar numberDays=0;\nif([0,2,4,6,8,9,11].includes(previous.date.getMonth())){\n    numberDays =31;\n}\nelse if(previous.date.getMonth()==1){\n    numberDays =30;\n}\nelse{\n    if(previous.date.getFullYear()%4==0)\n        numberDays=29;\n    else \n        numberDays=28\n}\nfor(var i=1;i<=numberDays;i++){\n    hash[i] = hash[i] || [];\n}\nmsg.payload= hash;\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":520,"wires":[["3da51abc.07fb96"]]},{"id":"4f683f01.f5d7b","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"Config","operation":"update","x":720,"y":120,"wires":[["cde0e0b7.51abe"]]},{"id":"a43529ef.0b78e8","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/recommandation","method":"post","upload":false,"swaggerDoc":"","x":260,"y":120,"wires":[["a4c9917.ff2247"]]},{"id":"a4c9917.ff2247","type":"function","z":"b9daa40a.159ce8","name":"","func":"msg.payload =[{Value:\"Recommandation\"},{$set:msg.req.body}];\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":120,"wires":[["4f683f01.f5d7b","bfc51cf3.e973d","bc4ffd47.e98ef","90ec26da.c27468"]]},{"id":"b7688e63.a3feb","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/recommandation","method":"get","upload":false,"swaggerDoc":"","x":220,"y":420,"wires":[["84788a39.0cd168"]]},{"id":"2467611c.c8d24e","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":580,"y":420,"wires":[["cde0e0b7.51abe"]]},{"id":"84788a39.0cd168","type":"function","z":"b9daa40a.159ce8","name":"","func":"var request = [{\"Value\":\"Recommandation\"},msg.payload];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":420,"wires":[["2467611c.c8d24e"]]},{"id":"6746226d.b4a8bc","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"Config","operation":"update","x":680,"y":480,"wires":[["cde0e0b7.51abe"]]},{"id":"78242cb6.902cc4","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/configuration","method":"post","upload":false,"swaggerDoc":"","x":210,"y":480,"wires":[["ae2b8f3e.6f948"]]},{"id":"ae2b8f3e.6f948","type":"function","z":"b9daa40a.159ce8","name":"","func":"msg.payload =[{Value:\"Configuration\"},{$set:msg.req.body}];\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":480,"wires":[["6746226d.b4a8bc"]]},{"id":"f174eb43.da87c8","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/configuration","method":"get","upload":false,"swaggerDoc":"","x":210,"y":580,"wires":[["a68c4468.5fdad8"]]},{"id":"3b0d1f38.77ada","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":580,"y":560,"wires":[["cde0e0b7.51abe"]]},{"id":"a68c4468.5fdad8","type":"function","z":"b9daa40a.159ce8","name":"","func":"var request = [{\"Value\":\"Configuration\"},msg.payload];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":580,"wires":[["3b0d1f38.77ada"]]},{"id":"d312ac17.d8c2b","type":"mongodb2 in","z":"ed0c995d.e2e7f8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"Current_State","operation":"update","x":1020,"y":180,"wires":[[]]},{"id":"26cb4eca.2d7212","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"msg.payload =[{},{$set:{\"isSitting\":msg.payload.IsSomeoneThere}},{ upsert: true }];\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":340,"wires":[["d312ac17.d8c2b"]]},{"id":"12901cff.5ea7e3","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"msg.payload =[{},{$set:{\"currentSpeed\":msg.payload.vitesse}}];\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":420,"wires":[["d312ac17.d8c2b"]]},{"id":"5a9da3b1.d44cfc","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"msg.payload =[{},{$set:{\"currentPosX\":msg.payload.pos_x, \"currentPosY\":msg.paylooad.pos_y}}];\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":220,"wires":[["d312ac17.d8c2b"]]},{"id":"d7a5edc4.a355e","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"msg.payload =[{},{$set:{\"currentAngle\":msg.payload.angle}},{ upsert: true }];\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":120,"wires":[["d312ac17.d8c2b"]]},{"id":"a2119568.f267a8","type":"mongodb2 in","z":"ed0c995d.e2e7f8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"back_angle","operation":"insert","x":940,"y":80,"wires":[[]]},{"id":"d710158.344d1e8","type":"json","z":"ed0c995d.e2e7f8","name":"","property":"payload","action":"obj","pretty":false,"x":330,"y":320,"wires":[["51301068.f29e4","26cb4eca.2d7212","ada903e8.cfb9e"]]},{"id":"d353cbdb.5d4f58","type":"json","z":"ed0c995d.e2e7f8","name":"","property":"payload","action":"obj","pretty":false,"x":350,"y":120,"wires":[["d7a5edc4.a355e","cefddfdf.eda88"]]},{"id":"1c01fe0f.4afed2","type":"json","z":"ed0c995d.e2e7f8","name":"","property":"payload","action":"obj","pretty":false,"x":350,"y":220,"wires":[["5a9da3b1.d44cfc","6c4c2373.39613c"]]},{"id":"195ec0a8.18333f","type":"json","z":"ed0c995d.e2e7f8","name":"","property":"payload","action":"obj","pretty":false,"x":330,"y":380,"wires":[["f48b2a1f.dced18","12901cff.5ea7e3"]]},{"id":"14d35acb.066145","type":"switch","z":"ed0c995d.e2e7f8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":750,"y":80,"wires":[["a2119568.f267a8"]]},{"id":"eda9ac1f.df1a1","type":"mongodb2 in","z":"ed0c995d.e2e7f8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"sitting_time","operation":"insert","x":840,"y":300,"wires":[[]]},{"id":"128731b6.446e4e","type":"http in","z":"c6f5a9d0.2bf118","name":"","url":"/simulate","method":"post","upload":false,"swaggerDoc":"","x":300,"y":300,"wires":[["176575a7.f0811a","92a4d674.266a18"]]},{"id":"bbb4df43.97676","type":"http response","z":"c6f5a9d0.2bf118","name":"","statusCode":"","headers":{},"x":940,"y":200,"wires":[]},{"id":"bd8218c8.55a0f8","type":"http in","z":"79c89fe4.873e6","name":"","url":"/sittingTime","method":"get","upload":false,"swaggerDoc":"","x":200,"y":600,"wires":[["1bcf1c7a.a04914"]]},{"id":"c5e09040.3c9c6","type":"function","z":"79c89fe4.873e6","name":"get month ","func":"\nlet offset =0;\nif(msg.payload.Offset !=null)\n    offset = parseInt(msg.payload.Offset)*60*60*1000;\nmsg.offset=offset;\nvar moment = context.global.momentjs;\nlet min=new Date(parseInt(msg.payload.Day));\nmin.setDate(1);\nmin.setUTCHours(0,0,0,0);\nvar momentMin =moment(min);\nmomentMin.add(-offset,\"ms\");\nvar max=moment(momentMin);\nmax.add(1, 'months');\n msg.payload =[[{ \"$match\": { date: {$gte:new Date(momentMin), $lt:new Date(max)} } },\n  { \"$project\": { \n         \"date\": {$add:[\"$date\",offset]},\n         \"isSitting\":\"$isSitting\"\n    }},\n    { $sort: { date: 1}}\n   ]];\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":600,"wires":[["541f44d8.f48c2c"]]},{"id":"541f44d8.f48c2c","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find month","collection":"sitting_time","operation":"aggregate.toArray","x":810,"y":600,"wires":[["c705b457.40f7d8"]]},{"id":"c705b457.40f7d8","type":"function","z":"79c89fe4.873e6","name":"format result","func":"let previous = msg.payload[0];\nvar retour={};\nmsg.payload.shift();\nretour[previous.date.getUTCDate()]=0\nif(!previous.isSitting){\n    temp = new Date(previous.date);\n    temp.setUTCHours(0,0,0,0);\n    retour[previous.date.getUTCDate()]+=Math.round((previous.date.getTime()-temp.getTime())/60000);\n}\n\nfor(let time of msg.payload){\n    if(retour[time.date.getUTCDate()]==null)\n        retour[time.date.getUTCDate()]=0\n    if(time.date.getUTCDate()==previous.date.getUTCDate()){\n        if(previous.isSitting & !time.isSitting){\n            retour[previous.date.getUTCDate()]+=Math.round((time.date.getTime()-previous.date.getTime())/60000);\n            previous=time;\n        }\n        else if(!previous.isSitting & time.isSitting){\n            previous=time;\n        }\n    }\n    else{\n         if(previous.isSitting){\n            var temp = new Date(previous.date);\n            temp.setUTCHours(23,59,59,999);\n            retour[previous.date.getUTCDate()]+=Math.round((temp.getTime()-previous.date.getTime())/60000);\n            // temp = new Date(time.date);\n            // temp.setUTCHours(0,0,0,0);\n            // retour[time.date.getUTCDate()]+=Math.round((time.date.getTime()-temp.getTime())/60000);\n         }\n        previous=time;\n    }\n}\n//  if(previous.isSitting){\n//             var temp = new Date(previous.date);\n//             temp.setUTCHours(23,59,59,999);\n//             retour[previous.date.getUTCDate()]+=Math.round((temp.getTime()-previous.date.getTime())/60000);\n//          }\nvar numberDays=0;\nif([0,2,4,6,8,9,11].includes(previous.date.getMonth())){\n    numberDays =31;\n}\nelse if(previous.date.getMonth()==1){\n    numberDays =30;\n}\nelse{\n    if(previous.date.getFullYear()%4==0)\n        numberDays=29;\n    else \n        numberDays=28\n}\nfor(var i=1;i<=numberDays;i++){\n    retour[i] = retour[i] || 0;\n}\nmsg.payload= retour;\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":600,"wires":[["3da51abc.07fb96"]]},{"id":"92a4d674.266a18","type":"function","z":"c6f5a9d0.2bf118","name":"creation test","func":"var times = 0;\nvar timeStamps = 1517439600000;\nvar angles =0 ;\nvar docs=[];\nvar k =0;\nfor(j=0;j<62;j++){\n    for(i=0;i<300;i++){\n        var date = new Date(timeStamps);\n\n        var document = {date:date ,timestamp:timeStamps, isSitting:angles};\n\n        docs[k] =document;\n        \n        timeStamps +=288000;\n        angles = Math.round(Math.random()*1);\n        k++;\n    }\n    timeStamps +=288000;\n    angles = Math.round(Math.random()*1);\n}\nmsg.payload=[docs];\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":460,"wires":[["125383d9.5c892c","729ba250.f752ec"]]},{"id":"125383d9.5c892c","type":"debug","z":"c6f5a9d0.2bf118","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":770,"y":580,"wires":[]},{"id":"729ba250.f752ec","type":"mongodb2 in","z":"c6f5a9d0.2bf118","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"sitting_time","operation":"insertMany","x":760,"y":520,"wires":[[]]},{"id":"6bad49a4.0bd018","type":"inject","z":"da4609d5.3036c8","name":"","topic":"","payload":"{\"datetime\":\"2018-03-11:13:01:02\",\"angle\":35}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":60,"wires":[["c3b9ff8c.8355c"]]},{"id":"c3b9ff8c.8355c","type":"mqtt out","z":"da4609d5.3036c8","name":"angle","topic":"data/current_back_rest_angle","qos":"","retain":"","broker":"2b8661c7.194ede","x":330,"y":60,"wires":[]},{"id":"7803a8bb.c23928","type":"mqtt out","z":"da4609d5.3036c8","name":"sitt","topic":"data/current_is_someone_there","qos":"","retain":"","broker":"2b8661c7.194ede","x":330,"y":140,"wires":[]},{"id":"c81137a9.218838","type":"inject","z":"da4609d5.3036c8","name":"","topic":"","payload":"{\"datetime\":\"2018-02-04:23:00:00\",\"IsSomeoneThere\":0}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":120,"wires":[["7803a8bb.c23928"]]},{"id":"dc3b7f24.e70ef","type":"inject","z":"da4609d5.3036c8","name":"","topic":"","payload":"{\"datetime\":\"2018-02-04:23:00:00\",\"IsSomeoneThere\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":160,"wires":[["7803a8bb.c23928"]]},{"id":"cd524360.4301b","type":"function","z":"da4609d5.3036c8","name":"creation test angle","func":"\nvar docs=[\n{date:new Date(\"2018-02-01T08:00:00.000Z\"), timestamp:\"1517439600000\",angle:35, sitting:1},\n{date:new Date(\"2018-02-01T12:00:00.000Z\"), timestamp:\"1517439600000\",angle:12,sitting:1},\n{date:new Date(\"2018-02-01T12:30:00.000Z\"), timestamp:\"1517439600000\",angle:20,sitting:1},\n{date:new Date(\"2018-02-01T16:00:00.000Z\"), timestamp:\"1517439600000\",angle:35,sitting:1},\n{date:new Date(\"2018-02-01T20:00:00.000Z\"), timestamp:\"1517439600000\",angle:46,sitting:1},\n{date:new Date(\"2018-02-01T23:00:00.000Z\"), timestamp:\"1517439600000\",angle:46,sitting:0},\n{date:new Date(\"2018-02-02T10:00:00.000Z\"), timestamp:\"1517439600000\",angle:15,sitting:1},\n{date:new Date(\"2018-02-02T18:00:00.000Z\"), timestamp:\"1517439600000\",angle:15,sitting:0},\n{date:new Date(\"2018-02-04T09:00:00.000Z\"), timestamp:\"1517439600000\",angle:35,sitting:1},\n{date:new Date(\"2018-02-04T12:00:00.000Z\"), timestamp:\"1517439600000\",angle:12,sitting:1},\n{date:new Date(\"2018-02-04T12:30:00.000Z\"), timestamp:\"1517439600000\",angle:35,sitting:1},\n{date:new Date(\"2018-02-04T23:00:00.000Z\"), timestamp:\"1517439600000\",angle:35,sitting:0}\n];\nmsg.payload=[docs];\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["4376acd7.2d9024"]]},{"id":"4376acd7.2d9024","type":"mongodb2 in","z":"da4609d5.3036c8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"back_angle","operation":"insertMany","x":460,"y":300,"wires":[[]]},{"id":"c52426ed.6c2d08","type":"function","z":"da4609d5.3036c8","name":"creation test sitting","func":"var docs=[\n{date:new Date(\"2018-02-01T08:00:00.000Z\"), timestamp:\"1517439600000\",isSitting:1},\n{date:new Date(\"2018-02-01T23:00:00.000Z\"), timestamp:\"1517439600000\",isSitting:0},\n{date:new Date(\"2018-02-02T10:00:00.000Z\"), timestamp:\"1517439600000\",isSitting:1},\n{date:new Date(\"2018-02-02T18:00:00.000Z\"), timestamp:\"1517439600000\",isSitting:0},\n{date:new Date(\"2018-02-04T09:00:00.000Z\"), timestamp:\"1517439600000\",isSitting:1},\n{date:new Date(\"2018-02-04T23:00:00.000Z\"), timestamp:\"1517439600000\",isSitting:0}\n];\nmsg.payload=[docs];\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":400,"wires":[["d4c89718.1e4bd8"]]},{"id":"d4c89718.1e4bd8","type":"mongodb2 in","z":"da4609d5.3036c8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"sitting_time","operation":"insertMany","x":460,"y":400,"wires":[[]]},{"id":"dd1eeedc.1048f","type":"inject","z":"da4609d5.3036c8","name":"","topic":"","payload":"{\"datetime\":\"2018-03-11:13:01:02\",\"IsSomeoneThere\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":90,"y":300,"wires":[["cd524360.4301b"]]},{"id":"e720d2bb.dc388","type":"mongodb2 in","z":"ed0c995d.e2e7f8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"LastTime","collection":"back_angle","operation":"aggregate.toArray","x":1020,"y":260,"wires":[["607e252.184dddc"]]},{"id":"ce696998.b38988","type":"function","z":"ed0c995d.e2e7f8","name":"","func":" var flowContext = this.context.flow;\nflowContext.isSitting=msg.payload.IsSomeoneThere;\n var date = new Date(msg.payload.datetime);\n       date.setUTCMinutes(date.getMinutes()-date.getTimezoneOffset());\nmsg.back = {date:date ,timestamp:date.getTime(), isSitting:msg.payload.IsSomeoneThere};\n msg.payload =[[\n     {\n         \"$sort\":{date: 1}\n     },\n    {\n        \"$group\":{\n            \"_id\":null,\n           // \"date\":{$last:\"$date\"},\n            \"angle\":{$last:\"$angle\"}\n        }\n    }\n   ]];\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":260,"wires":[["e720d2bb.dc388"]]},{"id":"607e252.184dddc","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"msg.payload={\n    angle:msg.payload[0].angle, date:msg.back.date,timestamp:parseInt(msg.back.timestamp),sitting:msg.back.isSitting\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1170,"y":260,"wires":[["a663d635.c9a558"]]},{"id":"ada903e8.cfb9e","type":"switch","z":"ed0c995d.e2e7f8","name":"sitting=0","property":"payload.IsSomeoneThere","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":260,"wires":[["ce696998.b38988"]]},{"id":"a663d635.c9a558","type":"mongodb2 in","z":"ed0c995d.e2e7f8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"back_angle","operation":"insert","x":1300,"y":260,"wires":[[]]},{"id":"cb8f1b3e.c154b8","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/onemonth?Day=1517484102000&Offset=0","tls":"","x":1090,"y":160,"wires":[["f4ee485f.c665c8"]]},{"id":"ce528c0c.e0a63","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/onemonth?Day=1517484102000&Offset=2","tls":"","x":1090,"y":220,"wires":[["c4e4138e.9e1be"]]},{"id":"5c9971ee.a91c9","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/oneday?Day=1517484102000&Offset=0","tls":"","x":1090,"y":60,"wires":[["1fce875.d3c7179"]]},{"id":"78b21c9a.0d1334","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/monthsWithData?Offset=0","tls":"","x":1110,"y":380,"wires":[["d2e09292.64e08"]]},{"id":"be67c295.724f1","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/MonthsWithData?Offset=-9","tls":"","x":1110,"y":440,"wires":[["7a928942.66a808"]]},{"id":"ddbab8c2.e30378","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/daysWithData?Offset=2","tls":"","x":1110,"y":320,"wires":[["4a2bc940.d459d8"]]},{"id":"9285d82a.20a498","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/oneday?Day=1517484102000&Offset=2","tls":"","x":1090,"y":100,"wires":[["de46376.291b7c8"]]},{"id":"58842459.6654ac","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/daysWithData?Offset=0","tls":"","x":1110,"y":280,"wires":[["3839e354.b00c1c"]]},{"id":"acf11b2c.a40798","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/sittingTime?Day=1517484102000&Offset=0","tls":"","x":1110,"y":500,"wires":[["19857de6.7b4462"]]},{"id":"488ad7b8.637998","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/sittingTime?Day=1517484102000&Offset=-10","tls":"","x":1110,"y":560,"wires":[["e70f4e44.d8da7"]]},{"id":"68930c4.adc52f4","type":"inject","z":"da4609d5.3036c8","name":"","topic":"","payload":"{\"datetime\":\"2018-03-11:13:01:02\",\"IsSomeoneThere\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":90,"y":400,"wires":[["c52426ed.6c2d08"]]},{"id":"922360f7.46ec","type":"json","z":"4e4dbcc2.17d054","name":"","property":"payload","action":"obj","pretty":false,"x":430,"y":320,"wires":[["445de54c.95801c"]]},{"id":"16daffa2.467b7","type":"mongodb2 in","z":"4e4dbcc2.17d054","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"User","operation":"findOne","x":760,"y":340,"wires":[["b0d913b4.e7c34"]]},{"id":"b0d913b4.e7c34","type":"switch","z":"4e4dbcc2.17d054","name":"result","property":"payload","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":910,"y":340,"wires":[["50caa40d.80abec"],["db0ceff6.603c"]]},{"id":"445de54c.95801c","type":"function","z":"4e4dbcc2.17d054","name":"","func":"msg.payload = {token:msg.payload.authorization};\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":340,"wires":[["16daffa2.467b7"]]},{"id":"aba7736e.afb03","type":"http response","z":"4e4dbcc2.17d054","name":"","statusCode":"","headers":{},"x":1290,"y":340,"wires":[]},{"id":"e29f42ca.a113c","type":"function","z":"4e4dbcc2.17d054","name":"get body","func":"msg.backup=msg.payload ;\nmsg.payload = msg.req.headers;\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":320,"wires":[["922360f7.46ec"]]},{"id":"db0ceff6.603c","type":"function","z":"4e4dbcc2.17d054","name":"get body","func":"msg.payload=msg.backup ;\nreturn msg;","outputs":1,"noerr":0,"x":1080,"y":300,"wires":[[]]},{"id":"93bd1535.1e8c98","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":370,"y":200,"wires":[["f16ebdef.b321d"]]},{"id":"10b52e7e.2bc7c2","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":390,"y":280,"wires":[["fec815ee.b66618"]]},{"id":"6b826591.36243c","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":410,"y":400,"wires":[["6d0b7a7a.0d05d4"]]},{"id":"33bd490c.876dc6","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":410,"y":520,"wires":[["cbdade80.832ba"]]},{"id":"1bcf1c7a.a04914","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":410,"y":600,"wires":[["c5e09040.3c9c6"]]},{"id":"fca36f1b.c400a","type":"mqtt out","z":"1dab1279.d003ee","name":"","topic":"data/set_alarm","qos":"","retain":"","broker":"2b8661c7.194ede","x":880,"y":180,"wires":[]},{"id":"1923b59b.878aea","type":"mqtt out","z":"1dab1279.d003ee","name":"","topic":"data/required_period","qos":"","retain":"","broker":"2b8661c7.194ede","x":900,"y":300,"wires":[]},{"id":"acd9dee0.581ad","type":"mqtt out","z":"1dab1279.d003ee","name":"","topic":"data/required_back_rest_angle","qos":"","retain":"","broker":"2b8661c7.194ede","x":930,"y":360,"wires":[]},{"id":"1c195702.e30819","type":"mqtt out","z":"1dab1279.d003ee","name":"","topic":"data/required_duration","qos":"","retain":"","broker":"2b8661c7.194ede","x":900,"y":240,"wires":[]},{"id":"a8fe4166.90a7b","type":"function","z":"1dab1279.d003ee","name":"","func":"msg.payload=  msg.payload.State ===\"on\" ? 1 :0;\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":180,"wires":[["fca36f1b.c400a"]]},{"id":"22650eaf.d80212","type":"function","z":"1dab1279.d003ee","name":"","func":"msg.payload=45;\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":240,"wires":[["1c195702.e30819"]]},{"id":"f08456f1.aa22f8","type":"function","z":"1dab1279.d003ee","name":"","func":"msg.payload=2;\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":300,"wires":[["1923b59b.878aea"]]},{"id":"9a60005a.72bb3","type":"function","z":"1dab1279.d003ee","name":"","func":"msg.payload=15;\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":360,"wires":[["acd9dee0.581ad"]]},{"id":"d74bda99.8a8348","type":"inject","z":"1dab1279.d003ee","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"2","x":360,"y":240,"wires":[["22650eaf.d80212"]]},{"id":"674a1360.bb5e3c","type":"inject","z":"1dab1279.d003ee","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"4","x":345,"y":313,"wires":[["f08456f1.aa22f8"]]},{"id":"bf783d9a.157df","type":"inject","z":"1dab1279.d003ee","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"6","x":352,"y":375,"wires":[["9a60005a.72bb3"]]},{"id":"90869b6d.636e88","type":"http in","z":"1dab1279.d003ee","name":"","url":"/alert","method":"get","upload":false,"swaggerDoc":"","x":220,"y":180,"wires":[["55cf64d2.e7931c"]]},{"id":"4c76740e.843a4c","type":"mqtt out","z":"1dab1279.d003ee","name":"","topic":"config/calib_pressure_mat","qos":"","retain":"","broker":"2b8661c7.194ede","x":910,"y":420,"wires":[]},{"id":"68b6df65.8696d","type":"http in","z":"1dab1279.d003ee","name":"","url":"/calibrate","method":"get","upload":false,"swaggerDoc":"","x":230,"y":420,"wires":[["7a6176f3.bdbe58"]]},{"id":"4db2b363.77881c","type":"function","z":"1dab1279.d003ee","name":"","func":"msg.payload=  1\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":420,"wires":[["4c76740e.843a4c"]]},{"id":"55cf64d2.e7931c","type":"subflow:4e4dbcc2.17d054","z":"1dab1279.d003ee","x":410,"y":180,"wires":[["a8fe4166.90a7b","7e115d8f.58b764"]]},{"id":"7a6176f3.bdbe58","type":"subflow:4e4dbcc2.17d054","z":"1dab1279.d003ee","x":450,"y":420,"wires":[["4db2b363.77881c","17359388.23940c"]]},{"id":"d3adfe9c.210ea","type":"http response","z":"1dab1279.d003ee","name":"","statusCode":"","headers":{},"x":860,"y":500,"wires":[]},{"id":"17359388.23940c","type":"template","z":"1dab1279.d003ee","name":"return erreur ","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"result\":\"ok\"}","output":"str","x":670,"y":480,"wires":[["d3adfe9c.210ea"]]},{"id":"7e115d8f.58b764","type":"template","z":"1dab1279.d003ee","name":"return erreur ","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"result\":\"ok\"}","output":"str","x":630,"y":140,"wires":[["37358c65.cbeb74"]]},{"id":"37358c65.cbeb74","type":"http response","z":"1dab1279.d003ee","name":"","statusCode":"","headers":{},"x":850,"y":140,"wires":[]},{"id":"23b75a55.df6646","type":"mongodb2 in","z":"ed0c995d.e2e7f8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"gravity_Center","operation":"insert","x":680,"y":180,"wires":[[]]},{"id":"c4236f86.ae4f2","type":"mqtt out","z":"1dab1279.d003ee","name":"","topic":"config/calib_imu","qos":"","retain":"","broker":"2b8661c7.194ede","x":880,"y":560,"wires":[]},{"id":"e468a5e2.16d5f8","type":"http in","z":"79c89fe4.873e6","name":"","url":"/gravityCenter","method":"get","upload":false,"swaggerDoc":"","x":210,"y":680,"wires":[["acab6567.a37208"]]},{"id":"271144a7.d9084c","type":"function","z":"79c89fe4.873e6","name":"get day ","func":"\nlet offset =0;\nif(msg.payload.Offset !=null)\n    offset = parseInt(msg.payload.Offset)*60*60*1000;\n\nlet day=new Date(parseInt(msg.payload.Day));\nlet min=(day.setUTCHours(0,0,0,0))-offset;\nlet max = (day.setUTCHours(23,59,59,999))-offset;\n msg.payload =[[{ \"$match\": { date: {$gte:new Date(min), $lt:new Date(max)} } },\n  { \"$project\": { \n         \"date\": {$add:[\"$date\",offset]},\n         \"x\":\"$posX\",\n         \"y\":\"$posY\"\n    }},\n    { $sort: { date: 1}}\n   ]];\n\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":680,"wires":[["569a445d.30d6fc"]]},{"id":"569a445d.30d6fc","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find day","collection":"gravity_Center","operation":"aggregate.toArray","x":800,"y":680,"wires":[["2ad30822.103c88"]]},{"id":"acab6567.a37208","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":410,"y":680,"wires":[["271144a7.d9084c"]]},{"id":"2ad30822.103c88","type":"function","z":"79c89fe4.873e6","name":"format result","func":"var finalOutput ={};\nlet distinctTime= msg.payload;\nif(distinctTime!=null){\n    for(let time of distinctTime){\n        var lastTime=new Date(time.date);\n        lastTime.setUTCHours(0,0,0,0);\n        finalOutput[time.date.getTime()-lastTime.getTime()]={x:time.x,y:time.y};\n    }\n}\nmsg.payload = finalOutput;\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":680,"wires":[["3da51abc.07fb96"]]},{"id":"51b10bb.b8fadf4","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/gravityCenter?Day=1517484102000&Offset=-10","tls":"","x":1110,"y":680,"wires":[["3ac333ac.96148c"]]},{"id":"ac5544d.76fd8b8","type":"debug","z":"da4609d5.3036c8","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","x":1600,"y":580,"wires":[]},{"id":"a4d60f98.27b73","type":"function","z":"da4609d5.3036c8","name":"creation test centre pression","func":"\nvar docs=[\n{date:new Date(\"2018-02-01T08:00:00.000Z\"), timestamp:\"1517439600000\",x:0, y:0},\n{date:new Date(\"2018-02-01T12:00:00.000Z\"), timestamp:\"1517439600000\",x:-1.2, y:-5.2},\n{date:new Date(\"2018-02-01T12:30:00.000Z\"), timestamp:\"1517439600000\",x:-3.3, y:-4.3},\n{date:new Date(\"2018-02-01T16:00:00.000Z\"), timestamp:\"1517439600000\",x:2.4, y:-3.0},\n{date:new Date(\"2018-02-01T20:00:00.000Z\"), timestamp:\"1517439600000\",x:4.1, y:2.3},\n{date:new Date(\"2018-02-01T23:00:00.000Z\"), timestamp:\"1517439600000\",x:1.7, y:1.1},\n{date:new Date(\"2018-02-02T10:00:00.000Z\"), timestamp:\"1517439600000\",x:-3.8, y:6.5},\n{date:new Date(\"2018-02-02T18:00:00.000Z\"), timestamp:\"1517439600000\",x:2.5, y:3.6},\n{date:new Date(\"2018-02-04T09:00:00.000Z\"), timestamp:\"1517439600000\",x:3.1, y:0.6},\n{date:new Date(\"2018-02-04T12:00:00.000Z\"), timestamp:\"1517439600000\",x:1.6, y:-3.5},\n{date:new Date(\"2018-02-04T12:30:00.000Z\"), timestamp:\"1517439600000\",x:0.3, y:-5.1},\n{date:new Date(\"2018-02-04T23:00:00.000Z\"), timestamp:\"1517439600000\",x:-0.4, y:1}\n]\nmsg.payload=[docs];\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":480,"wires":[["19a47f60.544fc1"]]},{"id":"19a47f60.544fc1","type":"mongodb2 in","z":"da4609d5.3036c8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"gravity_Center","operation":"insertMany","x":540,"y":480,"wires":[[]]},{"id":"acae8973.72fab8","type":"inject","z":"da4609d5.3036c8","name":"","topic":"","payload":"{\"datetime\":\"2018-03-11:13:01:02\",\"IsSomeoneThere\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":90,"y":480,"wires":[["a4d60f98.27b73"]]},{"id":"8b2a5955.09f8e8","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/gravityCenter?Day=1517484102000&Offset=0","tls":"","x":1110,"y":620,"wires":[["8ae3a664.809648"]]},{"id":"d58ab2a6.9d44e","type":"http in","z":"62e9dd9c.3ec8b4","name":"","url":"/changePassword","method":"post","upload":false,"swaggerDoc":"","x":120,"y":280,"wires":[["2837a1dc.2d708e"]]},{"id":"2837a1dc.2d708e","type":"function","z":"62e9dd9c.3ec8b4","name":"get Username","func":"msg.payload= '{\"username\":\"'+msg.req.body.username+'\"}';\nvar crypto = context.global.cryptojs;\nmsg.pw = crypto.SHA256( msg.req.body.password).toString();\nmsg.newPassword = crypto.SHA256( msg.req.body.newPassword).toString();\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":280,"wires":[["9ea82417.491cb8"]]},{"id":"9e80e969.bc5eb8","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find user","collection":"User","operation":"findOne","x":660,"y":280,"wires":[["5c9515bf.c1de6c"]]},{"id":"9ea82417.491cb8","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"payload","action":"obj","pretty":false,"x":530,"y":280,"wires":[["9e80e969.bc5eb8"]]},{"id":"5c9515bf.c1de6c","type":"function","z":"62e9dd9c.3ec8b4","name":"validate Password","func":"if(msg.payload.password == msg.pw){\n    msg.payload =[{username:msg.payload.username},{$set:{\"password\":msg.newPassword}}];\n        msg.result = '{\"result\":\"0\"}';\n}\nelse\n    msg.result = '{\"result\":401}';\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":280,"wires":[["1ee344bd.f16f0b"]]},{"id":"1ee344bd.f16f0b","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"result","action":"obj","pretty":false,"x":1010,"y":280,"wires":[["88f93e56.526c5"]]},{"id":"88f93e56.526c5","type":"switch","z":"62e9dd9c.3ec8b4","name":"","property":"result.result","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"neq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1170,"y":340,"wires":[["d56ef679.fb5018"],["1ac988a8.1b48e7"]]},{"id":"d56ef679.fb5018","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"change password","collection":"User","operation":"update","x":1330,"y":280,"wires":[["1ac988a8.1b48e7"]]},{"id":"bd8c13e2.e69f6","type":"http response","z":"62e9dd9c.3ec8b4","name":"","statusCode":"","headers":{},"x":1450,"y":420,"wires":[]},{"id":"1ac988a8.1b48e7","type":"function","z":"62e9dd9c.3ec8b4","name":"send result","func":"msg.payload = msg.result;\nreturn msg;","outputs":1,"noerr":0,"x":1410,"y":360,"wires":[["bd8c13e2.e69f6"]]},{"id":"f2bfa75e.b30838","type":"mqtt in","z":"ed0c995d.e2e7f8","name":"config response","topic":"config/calibration_response","qos":"0","broker":"2b8661c7.194ede","x":240,"y":560,"wires":[["5e6bf631.0b5378"]]},{"id":"f527aeb6.769e2","type":"http in","z":"1dab1279.d003ee","name":"","url":"/calibrateIMU","method":"get","upload":false,"swaggerDoc":"","x":250,"y":560,"wires":[["7acd0e4b.bda97"]]},{"id":"4418021e.cc065c","type":"function","z":"1dab1279.d003ee","name":"","func":"msg.payload=  1\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":560,"wires":[["c4236f86.ae4f2"]]},{"id":"7acd0e4b.bda97","type":"subflow:4e4dbcc2.17d054","z":"1dab1279.d003ee","x":450,"y":560,"wires":[["4418021e.cc065c","d7c8408e.974c7"]]},{"id":"d7c8408e.974c7","type":"template","z":"1dab1279.d003ee","name":"return erreur ","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"result\":\"ok\"}","output":"str","x":670,"y":620,"wires":[["d9f03d00.c36cf"]]},{"id":"d9f03d00.c36cf","type":"http response","z":"1dab1279.d003ee","name":"","statusCode":"","headers":{},"x":850,"y":620,"wires":[]},{"id":"d4b4059c.39ef68","type":"http in","z":"da4609d5.3036c8","name":"","url":"/testBackEnd","method":"get","upload":false,"swaggerDoc":"","x":150,"y":360,"wires":[["ff61a7ad.7870e8"]]},{"id":"90a23488.ed4de8","type":"mongodb2 in","z":"da4609d5.3036c8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"change password","collection":"User","operation":"update","x":690,"y":360,"wires":[["b139fc36.d65bf"]]},{"id":"ff61a7ad.7870e8","type":"function","z":"da4609d5.3036c8","name":"","func":"if(msg.payload.password == msg.pw){\n    msg.payload =[{username:\"test\"},{$set:{\"token\":\"d30f8fadade7644e6525f8ad32b9f8aec3a478a4cb021a524c54fb0f3fdf2fcc\"}}];\n}\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":360,"wires":[["90a23488.ed4de8"]]},{"id":"3ac333ac.96148c","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"7200000\":{\"x\":-1.2,\"y\":-5.2},\"9000000\":{\"x\":-3.3,\"y\":-4.3},\"21600000\":{\"x\":2.4,\"y\":-3},\"36000000\":{\"x\":4.1,\"y\":2.3},\"46800000\":{\"x\":1.7,\"y\":1.1}};\nif(msg.payload===JSON.stringify(expected)){\n    msg.payload= {result:0,message:'Gravity Center -10: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'Gravity Center -10: \\nValeur attendu: '+JSON.stringify(expected)+' \\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;\n","outputs":1,"noerr":0,"x":1320,"y":680,"wires":[["1cac304e.5eec9"]]},{"id":"d2fbd461.d36b08","type":"http response","z":"da4609d5.3036c8","name":"","statusCode":"","headers":{},"x":1850,"y":520,"wires":[]},{"id":"8ae3a664.809648","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"28800000\":{\"x\":0,\"y\":0},\"43200000\":{\"x\":-1.2,\"y\":-5.2},\"45000000\":{\"x\":-3.3,\"y\":-4.3},\"57600000\":{\"x\":2.4,\"y\":-3},\"72000000\":{\"x\":4.1,\"y\":2.3},\"82800000\":{\"x\":1.7,\"y\":1.1}};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n     msg.payload= {result:0,message:'Gravity Center 0: ok'}; \n}\nelse{\n   msg.payload= {result:1,message:'Gravity Center 0: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":620,"wires":[["1cac304e.5eec9"]]},{"id":"1cac304e.5eec9","type":"join","z":"da4609d5.3036c8","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"15","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1570,"y":340,"wires":[["98039178.c317c"]]},{"id":"98039178.c317c","type":"sort","z":"da4609d5.3036c8","name":"","order":"ascending","as_num":true,"target":"payload","targetType":"msg","msgKey":"result","msgKeyType":"jsonata","seqKey":"payload","seqKeyType":"msg","x":1710,"y":520,"wires":[["d2fbd461.d36b08","ac5544d.76fd8b8"]]},{"id":"e70f4e44.d8da7","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"1\":780,\"2\":480,\"3\":60,\"4\":780,\"5\":0,\"6\":0,\"7\":0,\"8\":0,\"9\":0,\"10\":0,\"11\":0,\"12\":0,\"13\":0,\"14\":0,\"15\":0,\"16\":0,\"17\":0,\"18\":0,\"19\":0,\"20\":0,\"21\":0,\"22\":0,\"23\":0,\"24\":0,\"25\":0,\"26\":0,\"27\":0,\"28\":0,\"29\":0,\"30\":0};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'Sitting time -10: ok'}; \n}\nelse{\n    msg.payload= {result:1,message: 'Sitting time -10: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":560,"wires":[["1cac304e.5eec9"]]},{"id":"19857de6.7b4462","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"1\":900,\"2\":480,\"3\":0,\"4\":840,\"5\":0,\"6\":0,\"7\":0,\"8\":0,\"9\":0,\"10\":0,\"11\":0,\"12\":0,\"13\":0,\"14\":0,\"15\":0,\"16\":0,\"17\":0,\"18\":0,\"19\":0,\"20\":0,\"21\":0,\"22\":0,\"23\":0,\"24\":0,\"25\":0,\"26\":0,\"27\":0,\"28\":0,\"29\":0,\"30\":0};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'Sitting time 0: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'Sitting time 0: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":500,"wires":[["1cac304e.5eec9"]]},{"id":"d2e09292.64e08","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"2018\":[2]};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'Month with data time 0: ok'}; \n}\nelse{\n   msg.payload= {result:1,message:'Month with data 0: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":380,"wires":[["1cac304e.5eec9"]]},{"id":"7a928942.66a808","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"2018\":[2,1]};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'Month with data -9: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'Month with data -9: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":440,"wires":[["1cac304e.5eec9"]]},{"id":"4a2bc940.d459d8","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"2018\":{\"2\":[5,4,2,1]}};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'Day with data 2: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'Day with data 2: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":320,"wires":[["1cac304e.5eec9"]]},{"id":"3839e354.b00c1c","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"2018\":{\"2\":[4,2,1]}};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'Day with data 0: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'Day with data 0: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":280,"wires":[["1cac304e.5eec9"]]},{"id":"cde0e0b7.51abe","type":"http response","z":"b9daa40a.159ce8","name":"","statusCode":"","headers":{},"x":1130,"y":600,"wires":[]},{"id":"21ca71e5.fbb5fe","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/goal","method":"get","upload":false,"swaggerDoc":"","x":180,"y":660,"wires":[["e995576.05dbaa8"]]},{"id":"fd58072b.243318","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":580,"y":660,"wires":[["cde0e0b7.51abe"]]},{"id":"e995576.05dbaa8","type":"function","z":"b9daa40a.159ce8","name":"","func":"var request = [{\"Value\":\"Goal\"},msg.payload];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":660,"wires":[["fd58072b.243318"]]},{"id":"c4e4138e.9e1be","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"1\":[0,1800000,12600000,28800000,7199999],\"2\":[0,0,28800000,0,3600001],\"3\":[],\"4\":[0,1800000,0,44999999,0],\"5\":[0,0,0,3600001,0],\"6\":[],\"7\":[],\"8\":[],\"9\":[],\"10\":[],\"11\":[],\"12\":[],\"13\":[],\"14\":[],\"15\":[],\"16\":[],\"17\":[],\"18\":[],\"19\":[],\"20\":[],\"21\":[],\"22\":[],\"23\":[],\"24\":[],\"25\":[],\"26\":[],\"27\":[],\"28\":[],\"29\":[],\"30\":[]};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'one month 2: ok'}; \n}\nelse{\n   msg.payload= {result:1,message: 'one Month 2: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":220,"wires":[["1cac304e.5eec9"]]},{"id":"f4ee485f.c665c8","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={\"1\":[0,1800000,12600000,28800000,10800000],\"2\":[0,0,28800000,0,0],\"3\":[],\"4\":[0,1800000,0,48600000,0],\"5\":[],\"6\":[],\"7\":[],\"8\":[],\"9\":[],\"10\":[],\"11\":[],\"12\":[],\"13\":[],\"14\":[],\"15\":[],\"16\":[],\"17\":[],\"18\":[],\"19\":[],\"20\":[],\"21\":[],\"22\":[],\"23\":[],\"24\":[],\"25\":[],\"26\":[],\"27\":[],\"28\":[],\"29\":[],\"30\":[]};\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'one month 0: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'one month 0: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":160,"wires":[["1cac304e.5eec9"]]},{"id":"de46376.291b7c8","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected=[0,1800000,12600000,28800000,7199999];\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'one day 2: ok'}; \n}\nelse{\n   msg.payload= {result:1,message: 'one day 2: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":100,"wires":[["1cac304e.5eec9"]]},{"id":"1fce875.d3c7179","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected=[0,1800000,12600000,28800000,10800000];\nif(msg.payload.trim()===JSON.stringify(expected).trim()){\n    msg.payload= {result:0,message:'one day 0: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'one day 0: \\nValeur attendu: '+JSON.stringify(expected)+'\\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":60,"wires":[["1cac304e.5eec9"]]},{"id":"7445ce75.719e8","type":"http in","z":"79c89fe4.873e6","name":"lastDate","url":"/lastDate","method":"get","upload":false,"swaggerDoc":"","x":120,"y":120,"wires":[["1ab23a65.f2c4c6"]]},{"id":"5fde6af6.070d14","type":"function","z":"79c89fe4.873e6","name":"getMinMax","func":"\nlet offset =0;\nif(msg.payload.Offset !=null)\n    offset = parseInt(msg.payload.Offset)*60*60*1000;\n\n msg.payload =[[{ \"$sort\": { date: 1 } },\n { \"$group\": { \n         \"_id\": null, \n        \"lastDate\":{\"$last\": {$add:[\"$date\",offset]} }\n    }}\n   ]];\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":120,"wires":[["d14b1ba2.9cea68"]]},{"id":"d14b1ba2.9cea68","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"back_angle","operation":"aggregate.toArray","x":910,"y":120,"wires":[["97e55e6c.1c86"]]},{"id":"97e55e6c.1c86","type":"function","z":"79c89fe4.873e6","name":"FormatData","func":"var date = new Date(msg.payload[0].lastDate);\nmsg.payload =date.getTime();\nconsole.log(date);\nconsole.log(date.getTime());\n\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":120,"wires":[["3da51abc.07fb96"]]},{"id":"1ab23a65.f2c4c6","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":370,"y":120,"wires":[["5fde6af6.070d14"]]},{"id":"2b4014f9.e62f9c","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/goal","method":"post","upload":false,"swaggerDoc":"","x":220,"y":180,"wires":[["c2165ebd.f4e88"]]},{"id":"c2165ebd.f4e88","type":"function","z":"b9daa40a.159ce8","name":"","func":"msg.payload =[{Value:\"Goal\"},{$set:msg.req.body}];\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":180,"wires":[["62d22b6c.9fe194","bfc51cf3.e973d","bc4ffd47.e98ef","90ec26da.c27468"]]},{"id":"62d22b6c.9fe194","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"Config","operation":"update","x":720,"y":180,"wires":[["cde0e0b7.51abe"]]},{"id":"bfc51cf3.e973d","type":"switch","z":"b9daa40a.159ce8","name":"","property":"req.body.reduceWeight.tiltLength","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":670,"y":240,"wires":[["93182639.f79078"]]},{"id":"bc4ffd47.e98ef","type":"switch","z":"b9daa40a.159ce8","name":"","property":"req.body.reduceWeight.tiltFrequecy","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":670,"y":280,"wires":[["a8656620.abd478"]]},{"id":"90ec26da.c27468","type":"switch","z":"b9daa40a.159ce8","name":"","property":"req.body.reduceWeight.tiltAngle","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":670,"y":320,"wires":[["cb4cd9c8.e54b98"]]},{"id":"cb4cd9c8.e54b98","type":"function","z":"b9daa40a.159ce8","name":"","func":"msg.payload=msg.req.body.reduceWeight.tiltAngle;\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":320,"wires":[["7a4cfa59.f0ec44"]]},{"id":"a8656620.abd478","type":"function","z":"b9daa40a.159ce8","name":"","func":"msg.payload=msg.req.body.reduceWeight.tiltFrequecy;\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":280,"wires":[["1520ac2f.896894"]]},{"id":"93182639.f79078","type":"function","z":"b9daa40a.159ce8","name":"","func":"msg.payload=msg.req.body.reduceWeight.tiltLength;\nreturn msg;","outputs":1,"noerr":0,"x":823,"y":240,"wires":[["3b96d32b.1a480c"]]},{"id":"3b96d32b.1a480c","type":"mqtt out","z":"b9daa40a.159ce8","name":"","topic":"data/required_duration","qos":"","retain":"","broker":"2b8661c7.194ede","x":1120,"y":240,"wires":[]},{"id":"1520ac2f.896894","type":"mqtt out","z":"b9daa40a.159ce8","name":"","topic":"data/required_period","qos":"","retain":"","broker":"2b8661c7.194ede","x":1120,"y":280,"wires":[]},{"id":"7a4cfa59.f0ec44","type":"mqtt out","z":"b9daa40a.159ce8","name":"","topic":"data/required_back_rest_angle","qos":"","retain":"","broker":"2b8661c7.194ede","x":1130,"y":320,"wires":[]},{"id":"d91e4698.f0d148","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/lastDate?Offset=-10","tls":"","x":1110,"y":740,"wires":[["1bbfa625.d3672a"]]},{"id":"1bbfa625.d3672a","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected=1517749200000;\nif(msg.payload===JSON.stringify(expected)){\n    msg.payload= {result:0,message:'last Date -10: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'last Date -10: \\nValeur attendu: '+JSON.stringify(expected)+' \\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;\n","outputs":1,"noerr":0,"x":1320,"y":740,"wires":[["1cac304e.5eec9"]]},{"id":"eb07420c.6d9f9","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/lastDate?Offset=0","tls":"","x":1110,"y":800,"wires":[["5c9aef57.edd67"]]},{"id":"b139fc36.d65bf","type":"function","z":"da4609d5.3036c8","name":"","func":"msg.headers ={};\nmsg.headers[\"Authorization\"]=\"d30f8fadade7644e6525f8ad32b9f8aec3a478a4cb021a524c54fb0f3fdf2fcc\"\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":360,"wires":[["eb07420c.6d9f9","d91e4698.f0d148","51b10bb.b8fadf4","8b2a5955.09f8e8","acf11b2c.a40798","488ad7b8.637998","be67c295.724f1","78b21c9a.0d1334","ddbab8c2.e30378","58842459.6654ac","ce528c0c.e0a63","cb8f1b3e.c154b8","9285d82a.20a498","5c9971ee.a91c9","884d64c0.4cfb98"]]},{"id":"5c9aef57.edd67","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected=1517785200000;\nif(msg.payload===JSON.stringify(expected)){\n    msg.payload= {result:0,message:'last date 0: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'lastdate 0: \\nValeur attendu: '+JSON.stringify(expected)+' \\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;\n","outputs":1,"noerr":0,"x":1320,"y":800,"wires":[["1cac304e.5eec9"]]},{"id":"d02973b1.307ca","type":"function","z":"ed0c995d.e2e7f8","name":"","func":"msg.payload =[{},{$set:{\"currentCalib\":msg.payload.calibState}}];\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":560,"wires":[["d312ac17.d8c2b"]]},{"id":"5e6bf631.0b5378","type":"json","z":"ed0c995d.e2e7f8","name":"","property":"payload","action":"obj","pretty":false,"x":390,"y":560,"wires":[["d02973b1.307ca"]]},{"id":"2fe9866.fd70c7a","type":"http in","z":"79c89fe4.873e6","name":"isCalibrating","url":"/isCalibrating","method":"get","upload":false,"swaggerDoc":"","x":170,"y":740,"wires":[["d691dbf2.6ec1e8"]]},{"id":"d691dbf2.6ec1e8","type":"subflow:4e4dbcc2.17d054","z":"79c89fe4.873e6","name":"","x":370,"y":740,"wires":[["c78dfd15.05695"]]},{"id":"c78dfd15.05695","type":"function","z":"79c89fe4.873e6","name":"get month ","func":" msg.payload =[[{ \"$match\": { Value: \"CurrentState\" } },\n  { \"$project\": { \n         \"currentCalib\": \"$currentCalib\"\n    }}\n   ]];\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":740,"wires":[["d80d7d9b.e24bd"]]},{"id":"d80d7d9b.e24bd","type":"mongodb2 in","z":"79c89fe4.873e6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"getCalibState","collection":"Current_State","operation":"aggregate.toArray","x":760,"y":740,"wires":[["2aa866ce.a6e74a"]]},{"id":"2aa866ce.a6e74a","type":"function","z":"79c89fe4.873e6","name":"format result","func":"msg.payload = {result:msg.payload[0].currentCalib};\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":740,"wires":[["3da51abc.07fb96"]]},{"id":"ba8552a0.a54f2","type":"function","z":"da4609d5.3036c8","name":"creation test calibratoion state","func":"\nvar docs=[\n{ Value:\"CurrentState\",currentCalib:1}\n\n]\nmsg.payload=[docs];\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":540,"wires":[["a0f14a0d.c16028"]]},{"id":"a0f14a0d.c16028","type":"mongodb2 in","z":"da4609d5.3036c8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"Current_State","operation":"insertMany","x":560,"y":540,"wires":[[]]},{"id":"1a1350ea.db6fef","type":"inject","z":"da4609d5.3036c8","name":"","topic":"","payload":"{\"datetime\":\"2018-03-11:13:01:02\",\"IsSomeoneThere\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":90,"y":540,"wires":[["ba8552a0.a54f2"]]},{"id":"884d64c0.4cfb98","type":"http request","z":"da4609d5.3036c8","name":"","method":"GET","ret":"txt","url":"http://127.0.0.1:1880/isCalibrating","tls":"","x":1110,"y":860,"wires":[["ca275476.46df48"]]},{"id":"ca275476.46df48","type":"function","z":"da4609d5.3036c8","name":"","func":"var expected={result:1};\nif(msg.payload===JSON.stringify(expected)){\n    msg.payload= {result:0,message:'Calibrating: ok'}; \n}\nelse{\n    msg.payload= {result:1,message:'Calibrating : \\nValeur attendu: '+JSON.stringify(expected)+' \\nValeur obtenu : '+msg.payload}; \n}\nreturn msg;\n","outputs":1,"noerr":0,"x":1320,"y":860,"wires":[["1cac304e.5eec9"]]},{"id":"ac97c3c0.f2bd2","type":"mqtt in","z":"ed0c995d.e2e7f8","name":"","topic":"data/keepAlive","qos":"0","broker":"2b8661c7.194ede","x":230,"y":700,"wires":[[]]},{"id":"50caa40d.80abec","type":"function","z":"4e4dbcc2.17d054","name":"","func":"    msg.statusCode = 401\n\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":360,"wires":[["aba7736e.afb03"]]}]